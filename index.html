<!DOCTYPE html>
<html>
<head>
	<title>leaflet-draw-profile</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	 <style>
	   html, body, #map {
	      height:100%;
	      width:100%;
	      padding:0px;
	      margin:0px;
	   }
	</style>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
	<link rel="stylesheet" href="https://rawgit.com/MrMufflon/Leaflet.Elevation/master/dist/leaflet.elevation-0.0.4.css" />
	<link rel="stylesheet" href="https://rawgit.com/michaelguild13/Leaflet.draw/master/dist/leaflet.draw.css" />

	<script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
	<script type="text/javascript" src="https://rawgit.com/MrMufflon/Leaflet.Elevation/master/dist/leaflet.elevation-0.0.4.min.js"></script>
	<script type="text/javascript" src="https://rawgit.com/michaelguild13/Leaflet.draw/master/dist/leaflet.draw.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>

	<div id="map"></div>

	<script type="text/javascript">
		var map = L.map('map');

		var url = 'http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg',
			attr ='Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
			service = new L.TileLayer(url, {subdomains:"1234",attribution: attr});
	
		var bounds = new L.LatLngBounds(new L.LatLng(-44.6, 170), new L.LatLng(-45, 168));
		map.addLayer(service).fitBounds(bounds);
		
		//store 3d lines
		var lines3d = new L.layerGroup();
		map.addLayer(lines3d);
		
		// Initialize the draw control
		var drawControl = new L.Control.Draw({
		    draw: {
				polygon: false,
				polyline: true,
				rectangle: false,
				circle: false,
				marker: false
			}
		});
		map.addControl(drawControl);
		
		// Initialize the elevation control
		var el = L.control.elevation({
			position: "bottomright",
			theme: "steelblue-theme",
			height: 125
			}).addTo(map);
		
		//clear last profile
		map.on('draw:drawstart', function (e) {
			el.clear();
		});
		
		//do something after draw finishes
		map.on('draw:created', function (e) {
			var layer = e.layer;
			var feature = e.layer.toGeoJSON();
			
			//convert to esriJSON
			var esriJSON = '{"geometryType":"esriGeometryPolyline","spatialReference":{"wkid":"4326"},"fields": [],"features":[{"geometry": {"type":"polyline", "paths":[' + JSON.stringify(feature.geometry.coordinates) + ']}}]}'
			
			var requestURL = 'http://elevation.arcgis.com/arcgis/rest/services/Tools/ElevationSync/GPServer/Profile/execute';
						
			//do ajax call
			$.ajax({
				type: "POST",
				url: requestURL,
				data: 'InputLineFeatures=' + esriJSON + '&returnZ=true&f=pjson',
				dataType: "json",
				success: function(json){	

					var coords = json.results[0].value.features[0].geometry.paths[0];
					if (coords.length > 0) {
					
						var geojson = {"name":"NewFeatureType","type":"FeatureCollection"
						,"features":[
						{"type":"Feature","geometry":{"type":"LineString","coordinates":coords},"properties":""}
						]};						
						
						var layer = L.geoJson(geojson,{
							onEachFeature: el.addData.bind(el)
						});
	
						//add line to map
						lines3d.addLayer(layer);
					}
				}
			});
		});
	</script>
</body>
</html>